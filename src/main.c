#include <stdio.h>
#include <stdlib.h>
#include "occgrid.h"

void initCostmap(unsigned int size_x, unsigned int size_y, double resolution, unsigned char default_value, double origin_x, double origin_y, double origin_z) {
    printf("Initialize Master Costmap\n");

    master_observation.rolling_window_ = true;
    master_observation.min_obstacle_height_ = -3.05;
    master_observation.max_obstacle_height_ = 2.0;
    master_observation.raytrace_range_ = 101.0;

    master_observation.master_costmap.size_x = size_x;
    master_observation.master_costmap.size_y = size_y;
    master_observation.master_costmap.default_value = default_value;

    master_observation.master_resolution = resolution;

    master_observation.master_origin.x = origin_x;
    master_observation.master_origin.y = origin_y;
    master_observation.master_origin.z = origin_z;

    for (int i = 0; i < master_observation.master_costmap.size_x * master_observation.master_costmap.size_y; i++) {
        master_observation.master_costmap.costmap_[i] = master_observation.master_costmap.default_value;
    }
}

void addStaticObstacle(unsigned char* obstacle_type) {
    if (obstacle_type == "border") {
        printf("Add Static Obstacle: Wall Border \n");
        for (int i = 0; i < master_observation.master_costmap.size_x; i++) {
            for (int j = 0; j < master_observation.master_costmap.size_y; j++) {
                int index = master_observation.master_costmap.size_x * j + i;
                if (i == (int) master_observation.master_origin.x || i == master_observation.master_costmap.size_x - 1) master_observation.master_costmap.costmap_[index] = 1;
                else if (j == (int) master_observation.master_origin.y || j == master_observation.master_costmap.size_y - 1 ) master_observation.master_costmap.costmap_[index] = 1;
            }
        }
    }
}

void printMap() {
    printf("map: \n");
    for (int i = 0; i < master_observation.master_costmap.size_y; i++) {
        for (int j = 0; j < master_observation.master_costmap.size_x; j++) {
            int index = i * master_observation.master_costmap.size_y + j;
            printf("%2d", master_observation.master_costmap.costmap_[index]);
        }
        printf("\n\n");
    }
}

//TODO: Retrieve global parameters such as origin, resolution, etc.
int main()
{
    //Initialize costmap with default cost value
    initCostmap(100, 100, 2.0, 0, 0.0, 0.0, 0.0);

    printMap();

    //Add a static obstacle along the outer borders of costmap window
    addStaticObstacle("border");

    printMap();

    //char array[] = {249, 23, 154, 64, 124, 77, 139, 62, 27, 227, 27, 192, 121, 46, 154, 64, 174, 152, 88, 62, 27, 227, 27, 192};
    //char data[] = {146, 37, 39, 66, 155, 83, 83, 193, 52, 108, 173, 63, 143, 52, 44, 66, 165, 71, 99, 193, 16, 124, 179, 63, 155, 253, 42, 66, 10, 63, 107, 193, 208, 18, 179, 63};
    /*char data[] = {146, 37, 39, 66, 155, 83, 83, 193, 52, 108, 173, 63, 143, 52, 44, 66, 165, 71, 99, 193, 16, 124, 179, 63, 155, 253, 42, 66, 10, 63, 107, 193, 208, 18, 179, 63,
    27, 61, 142, 64, 158, 217, 242, 63, 24, 227, 27, 192, 242, 250, 142, 64, 75, 171, 235, 63, 24, 227, 27, 192, 249, 178, 143, 64, 79, 115, 228, 63, 24, 227, 27, 192,
    39, 101, 144, 64, 130, 50, 221, 63, 24, 227, 27, 192, 128, 17, 145, 64, 4, 233, 213, 63, 24, 227, 27, 192, 239, 183, 145, 64, 56, 151, 206, 63, 24, 227, 27, 192, 111, 88, 146,
    64, 41, 61, 199, 63, 24, 227, 27, 192, 7, 243, 146, 64, 82, 219, 191, 63, 24, 227, 27, 192, 155, 135, 147, 64, 242, 113, 184, 63, 24, 227, 27, 192, 60, 22, 148, 64, 73, 1, 177,
    63, 24, 227, 27, 192, 220, 158, 148, 64, 161, 137, 169, 63, 24, 227, 27, 192, 107, 33, 149, 64, 171, 11, 162, 63, 24, 227, 27, 192, 247, 157, 149, 64, 30, 135, 154, 63, 24, 227,
    27, 192, 98, 20, 150, 64, 199, 252, 146, 63, 24, 227, 27, 192, 200, 132, 150, 64, 153, 108, 139, 63, 24, 227, 27, 192, 4, 239, 150, 64, 229, 214, 131, 63, 24, 227, 27, 192, 41,
    83, 151, 64, 225, 120, 120, 63, 24, 227, 27, 192, 57, 177, 151, 64, 171, 57, 105, 63, 24, 227, 27, 192, 9, 9, 152, 64, 10, 242, 89, 63, 24, 227, 27, 192, 196, 90, 152, 64, 253,
    161, 74, 63, 24, 227, 27, 192, 79, 166, 152, 64, 174, 74, 59, 63, 24, 227, 27, 192, 166, 235, 152, 64, 225, 235, 43, 63, 24, 227, 27, 192, 206, 42, 153, 64, 141, 134, 28, 63, 24,
    227, 27, 192, 194, 99, 153, 64, 240, 27, 13, 63, 24, 227, 27, 192, 129, 150, 153, 64, 158, 86, 251, 62, 24, 227, 27, 192, 4, 195, 153, 64, 71, 109, 220, 62, 24, 227, 27, 192, 81,
    233, 153, 64, 87, 124, 189, 62, 24, 227, 27, 192, 100, 9, 154, 64, 10, 132, 158, 62, 24, 227, 27, 192, 67, 35, 154, 64, 112, 15, 127, 62, 24, 227, 27, 192, 219, 54, 154, 64, 102,
    10, 65, 62, 24, 227, 27, 192, 57, 68, 154, 64, 82, 2, 3, 62, 24, 227, 27, 192, 95, 75, 154, 64, 82, 238, 137, 61, 24, 227, 27, 192};*/
    char data[] = {117, 25, 218, 65, 71, 225, 58, 58, 56, 162, 115, 63, 6, 241, 222, 65, 215, 239, 178, 190, 133, 217, 120, 63, 56, 1, 228, 65, 10, 55, 55, 191, 35, 88, 126, 63, 171,
    78, 233, 65, 41, 178, 140, 191, 233, 17, 130, 63, 0, 222, 238, 65, 164, 42, 192, 191, 10, 33, 133, 63, 216, 180, 244, 65, 20, 57, 246, 191, 71, 93, 136, 63, 215, 18, 249, 65, 235,
    119, 22, 192, 169, 203, 138, 63, 203, 168, 0, 66, 158, 125, 53, 192, 102, 107, 143, 63, 221, 18, 4, 66, 92, 25, 85, 192, 84, 70, 147, 63, 173, 68, 7, 66, 251, 194, 117, 192, 118,
    233, 150, 63, 216, 199, 10, 66, 92, 57, 140, 192, 87, 238, 154, 63, 197, 76, 14, 66, 87, 86, 158, 192, 59, 253, 158, 63, 89, 148, 18, 66, 128, 37, 178, 192, 59, 238, 163, 63, 176,
    202, 22, 66, 23, 206, 198, 192, 153, 213, 168, 63, 199, 54, 26, 66, 41, 70, 219, 192, 5, 228, 172, 63, 69, 174, 34, 66, 225, 56, 248, 192, 166, 166, 182, 63, 219, 88, 40, 66, 165,
    57, 9, 193, 92, 82, 189, 63, 88, 116, 46, 66, 42, 92, 23, 193, 238, 138, 196, 63, 144, 10, 53, 66, 38, 161, 38, 193, 64, 93, 204, 63, 243, 160, 62, 66, 130, 146, 57, 193, 184, 165,
    215, 63, 2, 233, 56, 66, 153, 156, 122, 193, 215, 88, 213, 63, 190, 198, 55, 66, 95, 181, 129, 193, 97, 201, 212, 63, 216, 60, 53, 66, 55, 65, 138, 193, 66, 114, 211, 63, 206, 14,
    52, 66, 63, 144, 142, 193, 56, 237, 210, 63, 128, 111, 231, 65, 125, 61, 19, 194, 0, 14, 198, 63, 220, 94, 205, 65, 135, 23, 6, 194, 179, 134, 178, 63, 203, 129, 220, 65, 9, 201,
    19, 194, 243, 202, 194, 63, 64, 128, 204, 65, 139, 182, 12, 194, 184, 169, 183, 63, 0, 103, 192, 65, 176, 242, 7, 194, 118, 192, 175, 63, 77, 233, 186, 65, 191, 166, 7, 194, 228,
    193, 173, 63, 210, 199, 181, 65, 196, 138, 7, 194, 222, 13, 172, 63, 71, 126, 179, 65, 178, 138, 9, 194, 48, 15, 173, 63, 20, 165, 163, 65, 124, 232, 0, 194, 235, 207, 160, 63, 142,
    43, 154, 65, 140, 197, 249, 193, 100, 128, 154, 63, 79, 188, 148, 65, 233, 225, 247, 193, 28, 24, 152, 63, 127, 131, 143, 65, 66, 35, 246, 193, 51, 214, 149, 63, 167, 1, 140, 65, 169,
    53, 247, 193, 248, 86, 149, 63, 148, 237, 137, 65, 189, 214, 250, 193, 18, 104, 150, 63, 16, 183, 170, 65, 15, 246, 31, 194, 15, 116, 190, 63, 240, 88, 92, 65, 48, 221, 212, 193, 220,
    168, 123, 63, 84, 11, 99, 65, 197, 64, 226, 193, 71, 214, 132, 63, 12, 235, 91, 65, 204, 50, 226, 193, 54, 238, 131, 63, 245, 16, 88, 65, 242, 134, 229, 193, 199, 4, 133, 63, 138, 37,
    84, 65, 18, 234, 232, 193, 143, 37, 134, 63, 117, 88, 82, 65, 74, 217, 238, 193, 64, 190, 136, 63, 157, 108, 127, 65, 160, 26, 22, 194, 158, 225, 170, 63, 12, 87, 124, 65, 38, 159, 25,
    194, 69, 232, 173, 63, 34, 58, 125, 65, 71, 217, 31, 194, 25, 251, 179, 63, 242, 173, 70, 65, 135, 43, 2, 194, 120, 205, 145, 63, 23, 251, 60, 65, 84, 165, 0, 194, 41, 95, 143, 63, 28,
    124, 56, 65, 128, 162, 2, 194, 64, 228, 144, 63, 25, 181, 50, 65, 201, 203, 3, 194, 79, 129, 145, 63, 205, 65, 45, 65, 188, 66, 5, 194, 166, 118, 146, 63, 15, 118, 40, 65, 59, 85, 7,
    194, 197, 27, 148, 63, 174, 82, 37, 65, 10, 241, 10, 194, 210, 111, 151, 63, 207, 42, 32, 65, 32, 18, 13, 194, 15, 41, 153, 63, 1, 236, 68, 65, 225, 31, 54, 194, 235, 254, 196, 63, 208,
    220, 27, 65, 65, 177, 23, 194, 197, 127, 163, 63, 96, 129, 18, 65, 62, 103, 22, 194, 212, 144, 161, 63, 173, 141, 10, 65, 247, 111, 22, 194, 210, 22, 161, 63, 20, 206, 4, 65, 245, 245,
    24, 194, 164, 76, 163, 63, 199, 14, 251, 64, 27, 226, 25, 194, 151, 210, 163, 63, 253, 248, 238, 64, 126, 126, 28, 194, 28, 40, 166, 63, 120, 225, 228, 64, 33, 213, 32, 194, 110, 87,
    170, 63, 207, 158, 207, 64, 30, 169, 42, 194, 148, 243, 179, 63, 59, 203, 188, 64, 158, 124, 41, 194, 202, 93, 178, 63, 169, 175, 174, 64, 18, 174, 44, 194, 107, 102, 181, 63, 43, 57,
    158, 64, 118, 240, 45, 194, 13, 110, 182, 63, 125, 179, 144, 64, 166, 23, 51, 194, 48, 144, 187, 63, 169, 126, 102, 64, 189, 97, 62, 194, 87, 234, 198, 63, 143, 71, 63, 64, 229, 161, 61,
    194, 125, 242, 197, 63, 169, 16, 27, 64, 158, 38, 64, 194, 151, 109, 200, 63, 92, 149, 236, 63, 21, 88, 67, 194, 212, 161, 203, 63, 153, 11, 106, 191, 191, 67, 18, 194, 233, 104, 152, 63,
    38, 92, 141, 192, 225, 186, 137, 193, 179, 119, 20, 63, 198, 194, 168, 192, 130, 202, 148, 193, 179, 143, 33, 63, 151, 47, 176, 192, 47, 55, 148, 193, 230, 144, 33, 63, 69, 112, 110, 193,
    209, 57, 12, 194, 71, 169, 159, 63, 43, 167, 156, 193, 92, 2, 50, 194, 48, 220, 203, 63, 66, 68, 165, 193, 41, 175, 47, 194, 230, 170, 203, 63, 128, 109, 169, 193, 96, 98, 46, 194, 146,
    117, 203, 63, 153, 7, 11, 194, 49, 216, 12, 194, 158, 135, 210, 63, 27, 79, 6, 194, 130, 175, 4, 194, 233, 247, 200, 63, 99, 94, 2, 194, 202, 48, 251, 193, 194, 209, 192, 63, 187, 98, 254,
    193, 94, 251, 238, 193, 15, 2, 186, 63, 148, 51, 247, 193, 1, 116, 226, 193, 251, 198, 178, 63, 30, 112, 240, 193, 120, 195, 214, 193, 28, 9, 172, 63, 99, 44, 234, 193, 174, 239, 203, 193,
    66, 209, 165, 63, 166, 33, 228, 193, 46, 176, 193, 193, 97, 233, 159, 63, 112, 25, 222, 193, 153, 208, 183, 193, 102, 40, 154, 63, 134, 183, 217, 193, 23, 160, 175, 193, 5, 173, 149, 63,
    132, 28, 213, 193, 188, 136, 167, 193, 233, 38, 145, 63, 29, 167, 208, 193, 4, 212, 159, 193, 36, 214, 140, 63, 230, 116, 204, 193, 106, 147, 152, 193, 205, 203, 136, 63, 235, 127, 200,
    193, 167, 188, 145, 193, 10, 2, 133, 63, 20, 228, 199, 193, 130, 125, 141, 193, 123, 130, 131, 63, 111, 75, 196, 193, 84, 70, 135, 193, 202, 27, 128, 63, 164, 163, 193, 193, 242, 226,
    129, 193, 51, 201, 122, 63, 251, 98, 190, 193, 175, 135, 120, 193, 92, 182, 116, 63, 20, 183, 184, 193, 99, 143, 106, 193, 123, 175, 107, 63, 135, 73, 184, 193, 197, 145, 99, 193, 240,
    120, 105, 63, 70, 121, 181, 193, 23, 216, 89, 193, 0, 84, 100, 63, 0, 201, 178, 193, 240, 140, 80, 193, 245, 114, 95, 63, 115, 140, 175, 193, 166, 231, 70, 193, 0, 254, 89, 63, 211, 23,
    173, 193, 181, 106, 62, 193, 204, 154, 85, 63, 13, 98, 171, 193, 187, 246, 54, 193, 30, 57, 82, 63, 235, 213, 166, 193, 197, 193, 44, 193, 235, 116, 75, 63, 130, 254, 166, 193, 50, 162,
    39, 193, 235, 129, 74, 63, 1, 250, 170, 193, 27, 73, 38, 193, 87, 55, 78, 63, 29, 126, 173, 193, 191, 95, 35, 193, 112, 41, 80, 63, 151, 13, 176, 193, 59, 105, 32, 193, 0, 45, 82, 63,
    222, 168, 178, 193, 23, 101, 29, 193, 158, 66, 84, 63, 235, 38, 181, 193, 62, 47, 26, 193, 251, 57, 86, 63, 237, 218, 183, 193, 116, 14, 23, 193, 82, 117, 88, 63};

    PointCloud2 cloud;
    cloud.point_step = 12;
    Odometry odom;
    odom.pose.pose.position.x = 50.0;
    odom.pose.pose.position.y = 50.0;
    printf("Number of Elements = %d\n", (int) sizeof(data) / sizeof(data[0]));
    //printf("Number of Coordinates = %d\n", (int) sizeof(data) / sizeof(data[0]) / cloud.point_step);

    //Iterate through data array and convert to floats
    int num_coords = sizeof(data) / sizeof(data[0]) / cloud.point_step;
    //float new_data[num_coords * 3];
    for (int i = 0; i < num_coords; i++) {
        float f;
        for (int j = i * cloud.point_step; j < (i + 1) * cloud.point_step; j = j + sizeof(f)) {
            memcpy(&f, &data[j], sizeof(f));
            cloud.data[j / 4] = f;
            //printf("Data: %f\n", f);
        }
        printf("Data Point -> <%f, %f, %f>\n", cloud.data[i*3], cloud.data[i*3 + 1], cloud.data[i*3 + 2]);
    }

    //printf("Number of elements : %d\n", sizeof(cloud.data) / sizeof(cloud.data[0]));

    updateMap(cloud, 10.0, 10.0, 0.0, odom);

    printMap();

    return 0;
}
